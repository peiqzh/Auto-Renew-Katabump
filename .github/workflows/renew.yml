name: Auto Renew Katabump

on:  
  schedule:
    - cron: '0 12 */4 * *'  # 每4天运行一次（UTC时间 12:00）
  workflow_dispatch:  # 允许手动触发

jobs:
  auto_renew_katabump:
    runs-on: ubuntu-22.04

    env:
      ACCOUNTS: ${{ secrets.ACCOUNTS }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y xvfb
          
      - name: Get Chromium Version
        id: get_version
        run: |
          CHROME_VERSION=$(chromium-browser --version 2>/dev/null | grep -oE 'Chromium\s[0-9]+' | grep -oE '[0-9]+')
          if [ -z "$CHROME_VERSION" ]; then
            CHROME_VERSION=$(google-chrome --version 2>/dev/null | grep -oE 'Chrome\s[0-9]+' | grep -oE '[0-9]+')
          fi
          if [ -z "$CHROME_VERSION" ]; then
            echo "⚠️ 无法自动检测浏览器版本，使用最新稳定版本。"
          CHROME_VERSION="143"
          fi
          echo "Detected Chrome/Chromium Major Version: $CHROME_VERSION"
          echo "CHROME_MAJOR_VERSION=$CHROME_VERSION" >> $GITHUB_ENV

      - name: Start X Virtual Frame Buffer (Xvfb)
        # 在后台启动 Xvfb，创建一个虚拟屏幕 :99
        run: Xvfb :99 -ac &

      - name: Run Script in Stealth Mode (via Xvfb)
        env:
          DISPLAY: ':99'
          HEADLESS: 'false'
        run: python renew_katabump.py
